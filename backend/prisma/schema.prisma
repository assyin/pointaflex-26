generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Tenant {
  id                               String                            @id @default(uuid())
  createdAt                        DateTime                          @default(now())
  updatedAt                        DateTime                          @updatedAt
  companyName                      String
  slug                             String                            @unique
  logo                             String?
  email                            String
  phone                            String?
  address                          String?
  country                          String                            @default("MA")
  timezone                         String                            @default("Africa/Casablanca")
  city                             String?
  displayName                      String?
  hrEmail                          String?
  language                         String                            @default("fr")
  legalName                        String?
  attendance                       Attendance[]
  attendanceAttempts               AttendanceAttempt[]
  devices                          AttendanceDevice[]
  deviceAuditLogs                  DeviceAuditLog[]
  auditLogs                        AuditLog[]
  departments                      Department[]
  employees                        Employee[]
  holidays                         Holiday[]
  leaves                           Leave[]
  leaveTypes                       LeaveType[]
  notifications                    Notification[]
  overtime                         Overtime[]
  positions                        Position[]
  recovery                         Recovery[]
  RecoveryDay                      RecoveryDay[]
  supplementaryDays                SupplementaryDay[]
  reportHistory                    ReportHistory[]
  roles                            Role[]
  schedules                        Schedule[]
  shifts                           Shift[]
  shiftReplacements                ShiftReplacement[]
  sites                            Site[]
  siteManagers                     SiteManager[]
  teams                            Team[]
  settings                         TenantSettings?
  terminalMatriculeMappings        TerminalMatriculeMapping[]
  users                            User[]
  userTenantRoles                  UserTenantRole[]
  absenceNotificationLogs          AbsenceNotificationLog[]
  absencePartialNotificationLogs   AbsencePartialNotificationLog[]
  absenceTechnicalNotificationLogs AbsenceTechnicalNotificationLog[]
  attendanceAnomalies             AttendanceAnomaly[]
  emailConfig                      EmailConfig?
  emailLogs                        EmailLog[]
  emailTemplates                   EmailTemplate[]
  lateNotificationLogs             LateNotificationLog[]
  missingInNotificationLogs        MissingInNotificationLog[]
  missingOutNotificationLogs       MissingOutNotificationLog[]
  overtimePendingNotificationLogs  OvertimePendingNotificationLog[]

  @@index([slug])
}

model TenantSettings {
  id                                         String   @id @default(uuid())
  tenantId                                   String   @unique
  workDaysPerWeek                            Int      @default(6)
  maxWeeklyHours                             Decimal  @default(44)
  breakDuration                              Int      @default(60)
  alertWeeklyHoursExceeded                   Boolean  @default(true)
  alertInsufficientRest                      Boolean  @default(true)
  alertNightWorkRepetitive                   Boolean  @default(true)
  alertMinimumStaffing                       Boolean  @default(true)
  annualLeaveDays                            Int      @default(18)
  leaveApprovalLevels                        Int      @default(2)
  leaveIncludeSaturday                       Boolean  @default(false)  // Inclure samedi dans le calcul des congés
  overtimeRate                               Decimal  @default(1.25)
  nightShiftRate                             Decimal  @default(1.50)
  createdAt                                  DateTime @default(now())
  updatedAt                                  DateTime @updatedAt
  anticipatedLeave                           Boolean  @default(false)
  earlyToleranceExit                         Int      @default(5)
  firstDayOfWeek                             String   @default("monday")
  lateToleranceEntry                         Int      @default(10)
  monthlyPayrollEmail                        Boolean  @default(false)
  nightShiftEnd                              String   @default("06:00")
  nightShiftStart                            String   @default("21:00")
  overtimeRounding                           Int      @default(15)
  overtimeMinimumThreshold                   Int      @default(30)
  sfptExport                                 Boolean  @default(false)
  twoLevelWorkflow                           Boolean  @default(true)
  workingDays                                Json?
  recoveryConversionRate                     Decimal  @default(1.0)
  recoveryExpiryDays                         Int      @default(90)
  dailyWorkingHours                          Decimal  @default(7.33)
  requireBreakPunch                          Boolean  @default(false)
  requireScheduleForAttendance               Boolean  @default(true)
  absencePartialThreshold                    Int      @default(2)
  absenceDetectionTime                       String?  @default("01:00")
  temporaryMatriculeExpiryDays               Int      @default(8)
  enableInsufficientRestDetection            Boolean  @default(true)
  minimumRestHours                           Decimal  @default(11)
  minimumRestHoursNightShift                 Decimal? @default(12)
  doubleInDetectionWindow                    Int      @default(24)
  orphanInThreshold                          Int      @default(12)
  doublePunchToleranceMinutes                Int      @default(2)

  // ═══════════════════════════════════════════════════════════════════════════════
  // DÉTECTION AUTOMATIQUE IN/OUT - Configuration
  // ═══════════════════════════════════════════════════════════════════════════════

  // Pauses implicites (OUT suivi de IN dans un délai raisonnable)
  allowImplicitBreaks                        Boolean  @default(true)
  minImplicitBreakMinutes                    Int      @default(30)
  maxImplicitBreakMinutes                    Int      @default(120)

  // Clôture automatique des sessions orphelines
  autoCloseOrphanSessions                    Boolean  @default(true)
  autoCloseDefaultTime                       String   @default("23:59")
  autoCloseOvertimeBuffer                    Int      @default(0)      // Minutes à ajouter après fin shift (0 = désactivé, ex: 120 = 2h buffer pour heures sup)
  autoCloseCheckApprovedOvertime             Boolean  @default(true)   // Vérifier si overtime approuvé existe avant clôture

  // ═══════════════════════════════════════════════════════════════════════════════

  enableDoubleInPatternDetection             Boolean  @default(true)
  doubleInPatternAlertThreshold              Int      @default(3)
  allowMissingInForRemoteWork                Boolean  @default(true)
  allowMissingInForMissions                  Boolean  @default(true)
  missingInReminderEnabled                   Boolean  @default(true)
  missingInReminderDelay                     Int      @default(15)
  missingInReminderMaxPerDay                 Int      @default(2)
  holidayOvertimeEnabled                     Boolean  @default(true)
  holidayOvertimeRate                        Decimal  @default(2.0)
  holidayOvertimeAsNormalHours               Boolean  @default(false)
  enableMissingInPatternDetection            Boolean  @default(true)
  missingInPatternAlertThreshold             Int      @default(3)
  missingOutDetectionTime                    String?  @default("00:00")
  missingOutDetectionWindow                  Int      @default(12)
  allowMissingOutForRemoteWork               Boolean  @default(true)
  allowMissingOutForMissions                 Boolean  @default(true)
  missingOutReminderEnabled                  Boolean  @default(true)
  missingOutReminderDelay                    Int      @default(15)
  missingOutReminderBeforeClosing            Int      @default(30)
  enableMissingOutPatternDetection           Boolean  @default(true)
  missingOutPatternAlertThreshold            Int      @default(3)
  missingInDetectionWindowMinutes            Int      @default(30)
  missingInNotificationFrequencyMinutes      Int      @default(15)
  missingOutDetectionWindowMinutes           Int      @default(120)
  missingOutNotificationFrequencyMinutes     Int      @default(15)
  absenceNotificationFrequencyMinutes        Int      @default(60)
  absencePartialNotificationFrequencyMinutes Int      @default(30)
  lateNotificationFrequencyMinutes           Int      @default(15)
  lateNotificationThresholdMinutes           Int      @default(15)
  absenceDetectionBufferMinutes              Int      @default(60)
  overtimeAutoDetectType                     Boolean  @default(true)
  overtimeMajorationEnabled                  Boolean  @default(true)
  overtimeRateEmergency                      Decimal  @default(1.30)
  overtimeRateHoliday                        Decimal  @default(2.00)
  overtimeRateNight                          Decimal  @default(1.50)
  overtimeRateStandard                       Decimal  @default(1.25)
  overtimePendingNotificationTime            String   @default("09:00")
  overtimeAutoApprove                        Boolean  @default(false)
  overtimeAutoApproveMaxHours                Decimal? @default(4.0)

  // ═══════════════════════════════════════════════════════════════════════════════
  // VALIDATION DES POINTAGES AMBIGUS (SHIFTS DE NUIT) - Configuration
  // ═══════════════════════════════════════════════════════════════════════════════

  // Activer/désactiver la détection des pointages ambigus
  enableAmbiguousPunchDetection              Boolean  @default(true)

  // Fenêtre de tolérance autour du début du shift (en heures)
  ambiguousPunchWindowHours                  Int      @default(3)

  // Activer/désactiver les notifications d'escalade
  ambiguousPunchEscalationEnabled            Boolean  @default(true)

  // Délais d'escalade (en heures)
  ambiguousPunchEscalationLevel1Hours        Int      @default(24)   // Rappel au manager
  ambiguousPunchEscalationLevel2Hours        Int      @default(48)   // Escalade RH
  ambiguousPunchEscalationLevel3Hours        Int      @default(72)   // Escalade direction

  // Heure d'exécution du job d'escalade (format HH:MM)
  ambiguousPunchEscalationCheckTime          String   @default("09:00")

  // Destinataires des notifications d'escalade
  ambiguousPunchNotifyManager                Boolean  @default(true)
  ambiguousPunchNotifyHR                     Boolean  @default(true)
  ambiguousPunchNotifyEmployee               Boolean  @default(false)

  // ═══════════════════════════════════════════════════════════════════════════════
  // DÉTECTION ERREUR DE TYPE (WRONG TYPE) - Configuration
  // ═══════════════════════════════════════════════════════════════════════════════

  // Activer/désactiver la détection globale des erreurs de type IN/OUT
  enableWrongTypeDetection                   Boolean  @default(false)

  // Corriger automatiquement le type quand la confiance est suffisante
  wrongTypeAutoCorrect                       Boolean  @default(false)

  // Méthode de détection: SHIFT_BASED, CONTEXT_BASED, PATTERN_BASED, COMBINED
  wrongTypeDetectionMethod                   String   @default("SHIFT_BASED")

  // Marge en minutes autour du shift pour la détection (défaut: 120 min = 2h)
  wrongTypeShiftMarginMinutes                Int      @default(120)

  // Seuil de confiance minimum pour signaler (0-100, défaut: 80%)
  wrongTypeConfidenceThreshold               Int      @default(80)

  // Exiger une validation manuelle même en auto-correction
  wrongTypeRequiresValidation                Boolean  @default(true)

  tenant                                     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model User {
  id                                      String                            @id @default(uuid())
  createdAt                               DateTime                          @default(now())
  updatedAt                               DateTime                          @updatedAt
  tenantId                                String?
  email                                   String                            @unique
  password                                String
  firstName                               String
  lastName                                String
  phone                                   String?
  avatar                                  String?
  isActive                                Boolean                           @default(true)
  lastLoginAt                             DateTime?
  forcePasswordChange                     Boolean                           @default(false)
  role                                    LegacyRole?                       @default(EMPLOYEE)
  auditLogs                               AuditLog[]
  employee                                Employee?
  reportHistory                           ReportHistory[]
  tenant                                  Tenant?                           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  credentials                             UserCredentials?
  preferences                             UserPreferences?
  sessions                                UserSession[]
  userTenantRoles                         UserTenantRole[]
  absenceNotificationsAsEmployee          AbsenceNotificationLog[]          @relation("EmployeeAbsenceNotifications")
  absenceNotificationsAsManager           AbsenceNotificationLog[]          @relation("ManagerAbsenceNotifications")
  absencePartialNotificationsAsEmployee   AbsencePartialNotificationLog[]   @relation("EmployeeAbsencePartialNotifications")
  absencePartialNotificationsAsManager    AbsencePartialNotificationLog[]   @relation("ManagerAbsencePartialNotifications")
  absenceTechnicalNotificationsAsEmployee AbsenceTechnicalNotificationLog[] @relation("EmployeeAbsenceTechnicalNotifications")
  absenceTechnicalNotificationsAsManager  AbsenceTechnicalNotificationLog[] @relation("ManagerAbsenceTechnicalNotifications")
  attendanceAnomalies                    AttendanceAnomaly[]
  sentEmailsAsEmployee                    EmailLog[]                        @relation("EmployeeEmailLogs")
  sentEmailsAsManager                     EmailLog[]                        @relation("ManagerEmailLogs")
  lateNotificationsAsEmployee             LateNotificationLog[]             @relation("EmployeeLateNotifications")
  lateNotificationsAsManager              LateNotificationLog[]             @relation("ManagerLateNotifications")
  missingInNotificationsAsEmployee        MissingInNotificationLog[]        @relation("EmployeeMissingInNotifications")
  missingInNotificationsAsManager         MissingInNotificationLog[]        @relation("ManagerMissingInNotifications")
  missingOutNotificationsAsEmployee       MissingOutNotificationLog[]       @relation("EmployeeMissingOutNotifications")
  missingOutNotificationsAsManager        MissingOutNotificationLog[]       @relation("ManagerMissingOutNotifications")
  overtimePendingNotifications            OvertimePendingNotificationLog[]  @relation("ManagerOvertimePendingNotifications")

  @@index([tenantId])
  @@index([email])
}

model Employee {
  id                        String                     @id @default(uuid())
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  tenantId                  String
  matricule                 String
  firstName                 String
  lastName                  String
  email                     String?
  phone                     String?
  dateOfBirth               DateTime?
  address                   String?
  photo                     String?
  civilite                  String?
  situationFamiliale        String?
  nombreEnfants             Int?
  cnss                      String?
  cin                       String?
  ville                     String?
  rib                       String?
  region                    String?
  categorie                 String?
  position                  String
  positionId                String?
  hireDate                  DateTime
  contractType              String?
  siteId                    String?
  departmentId              String?
  teamId                    String?
  currentShiftId            String?
  fingerprintData           String?
  faceData                  String?
  rfidBadge                 String?
  qrCode                    String?
  pinCode                   String?
  isActive                  Boolean                    @default(true)
  isEligibleForOvertime     Boolean                    @default(true)
  maxOvertimeHoursPerMonth  Decimal?
  maxOvertimeHoursPerWeek   Decimal?
  overtimeEligibilityNotes  String?
  userId                    String?                    @unique
  attendance                Attendance[]
  attendanceAttempts        AttendanceAttempt[]
  managedDepartments        Department[]               @relation("DepartmentManager")
  currentShift              Shift?                     @relation(fields: [currentShiftId], references: [id])
  department                Department?                @relation(fields: [departmentId], references: [id])
  positionRef               Position?                  @relation(fields: [positionId], references: [id])
  site                      Site?                      @relation(fields: [siteId], references: [id])
  team                      Team?                      @relation(fields: [teamId], references: [id])
  tenant                    Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user                      User?                      @relation(fields: [userId], references: [id])
  leaves                    Leave[]
  notifications             Notification[]
  overtime                  Overtime[]
  recovery                  Recovery[]
  recoveryDays              RecoveryDay[]
  supplementaryDays         SupplementaryDay[]
  schedules                 Schedule[]
  replacementsAsOriginal    ShiftReplacement[]         @relation("OriginalEmployee")
  replacementsAsReplacement ShiftReplacement[]         @relation("ReplacementEmployee")
  managedSites              Site[]                     @relation("SiteManagerLegacy")
  siteManagements           SiteManager[]
  managedTeams              Team[]                     @relation("TeamManager")
  terminalMatriculeMappings TerminalMatriculeMapping[]
  credentials               UserCredentials?
  attendanceAnomalies      AttendanceAnomaly[]

  @@unique([tenantId, matricule])
  @@index([tenantId])
  @@index([siteId])
  @@index([departmentId])
  @@index([teamId])
  @@index([positionId])
  @@index([isActive])
  @@index([tenantId, departmentId, isActive])
}

model TerminalMatriculeMapping {
  id                String   @id @default(uuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  tenantId          String
  employeeId        String
  terminalMatricule String
  officialMatricule String
  deviceId          String?
  isActive          Boolean  @default(true)
  assignedAt        DateTime @default(now())
  employee          Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, terminalMatricule])
  @@index([tenantId])
  @@index([employeeId])
  @@index([terminalMatricule])
  @@index([isActive])
}

model Site {
  id           String             @id @default(uuid())
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  tenantId     String
  name         String
  address      String?
  city         String?
  latitude     Decimal?
  longitude    Decimal?
  code         String?
  phone        String?
  timezone     String?
  workingDays  Json?
  managerId    String?
  departmentId String?
  attendance   Attendance[]
  devices      AttendanceDevice[]
  employees    Employee[]
  department   Department?        @relation("SiteDepartment", fields: [departmentId], references: [id])
  manager      Employee?          @relation("SiteManagerLegacy", fields: [managerId], references: [id])
  tenant       Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  siteManagers SiteManager[]

  @@index([tenantId])
  @@index([tenantId, code])
  @@index([managerId])
  @@index([departmentId])
}

model Department {
  id           String              @id @default(uuid())
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  tenantId     String
  name         String
  code         String?
  description  String?
  managerId    String?
  manager      Employee?           @relation("DepartmentManager", fields: [managerId], references: [id])
  tenant       Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employees    Employee[]
  sites        Site[]              @relation("SiteDepartment")
  siteManagers SiteManager[]
  settings     DepartmentSettings?

  @@index([tenantId])
  @@index([managerId])
}

model DepartmentSettings {
  id                             String     @id @default(uuid())
  createdAt                      DateTime   @default(now())
  updatedAt                      DateTime   @updatedAt
  departmentId                   String     @unique
  department                     Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  // null = hériter du tenant, true/false = override
  wrongTypeDetectionEnabled      Boolean?
  wrongTypeAutoCorrect           Boolean?
  wrongTypeShiftMarginMinutes    Int?

  @@index([departmentId])
}

model SiteManager {
  id           String     @id @default(uuid())
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  tenantId     String
  siteId       String
  managerId    String
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  manager      Employee   @relation(fields: [managerId], references: [id], onDelete: Cascade)
  site         Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)
  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([siteId, departmentId])
  @@index([tenantId])
  @@index([siteId])
  @@index([managerId])
  @@index([departmentId])
}

model Position {
  id          String     @id @default(uuid())
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  tenantId    String
  name        String
  code        String?
  category    String?
  description String?
  employees   Employee[]
  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([category])
}

model Shift {
  id             String             @id @default(uuid())
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  tenantId       String
  name           String
  code           String
  startTime      String
  endTime        String
  breakStartTime String?            // Heure de début de pause (ex: "12:00")
  breakDuration  Int                @default(60)
  isNightShift   Boolean            @default(false)
  color          String?
  employees      Employee[]
  schedules      Schedule[]
  tenant         Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  replacements   ShiftReplacement[]

  @@index([tenantId])
}

model Team {
  id                String     @id @default(uuid())
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  tenantId          String
  name              String
  code              String
  description       String?
  managerId         String?
  rotationEnabled   Boolean    @default(false)
  rotationCycleDays Int?
  employees         Employee[]
  schedules         Schedule[]
  manager           Employee?  @relation("TeamManager", fields: [managerId], references: [id])
  tenant            Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model Schedule {
  id                   String                 @id @default(uuid())
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  tenantId             String
  employeeId           String
  teamId               String?
  shiftId              String
  date                 DateTime               @db.Date
  customStartTime      String?
  customEndTime        String?
  notes                String?
  status               ScheduleStatus         @default(PUBLISHED)
  publishedAt          DateTime?
  cancelledAt          DateTime?
  suspendedByLeaveId   String?
  suspendedAt          DateTime?
  employee             Employee               @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  shift                Shift                  @relation(fields: [shiftId], references: [id])
  suspendedByLeave     Leave?                 @relation("ScheduleSuspendedByLeave", fields: [suspendedByLeaveId], references: [id])
  team                 Team?                  @relation(fields: [teamId], references: [id])
  tenant               Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  attendanceAnomalies AttendanceAnomaly[]

  @@unique([employeeId, date, shiftId])
  @@index([tenantId])
  @@index([date])
  @@index([employeeId])
  @@index([status])
  @@index([suspendedByLeaveId])
}

model ShiftReplacement {
  id                    String            @id @default(uuid())
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  tenantId              String
  date                  DateTime          @db.Date
  originalEmployeeId    String
  replacementEmployeeId String
  shiftId               String
  reason                String?
  status                ReplacementStatus @default(PENDING)
  approvedBy            String?
  approvedAt            DateTime?
  originalEmployee      Employee          @relation("OriginalEmployee", fields: [originalEmployeeId], references: [id])
  replacementEmployee   Employee          @relation("ReplacementEmployee", fields: [replacementEmployeeId], references: [id])
  shift                 Shift             @relation(fields: [shiftId], references: [id])
  tenant                Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([date])
}

model AttendanceDevice {
  id                   String                 @id @default(uuid())
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  tenantId             String
  siteId               String?
  name                 String
  deviceId             String                 @unique
  deviceType           DeviceType
  ipAddress            String?

  // Securite API Key (Phase 1 - Conformite RGPD)
  apiKey               String?                // Deprecie - migration vers apiKeyHash
  apiKeyHash           String?                // Hash bcrypt de l'API Key
  apiKeyLastRotation   DateTime?              // Date derniere rotation
  apiKeyExpiresAt      DateTime?              // Date expiration (90 jours par defaut)

  // Liste blanche IP (Phase 1 - ISO 27001)
  allowedIPs           String[]               @default([])
  enforceIPWhitelist   Boolean                @default(false)

  // Monitoring avance
  isActive             Boolean                @default(true)
  lastSync             DateTime?
  lastHeartbeat        DateTime?              // Dernier heartbeat recu
  heartbeatInterval    Int                    @default(300)  // Intervalle en secondes (5 min)

  // Metriques de performance
  totalSyncs           Int                    @default(0)
  failedSyncs          Int                    @default(0)
  avgResponseTime      Int?                   // Temps reponse moyen (ms)

  // Relations
  attendance           Attendance[]
  attendanceAttempts   AttendanceAttempt[]
  site                 Site?                  @relation(fields: [siteId], references: [id])
  tenant               Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  attendanceAnomalies  AttendanceAnomaly[]
  auditLogs            DeviceAuditLog[]

  @@index([tenantId])
}

// Audit des operations sur les terminaux (Conformite RGPD/ISO 27001)
model DeviceAuditLog {
  id              String       @id @default(uuid())
  createdAt       DateTime     @default(now())
  tenantId        String
  deviceId        String
  action          DeviceAction
  performedBy     String?      // User ID
  performedByName String?      // Nom utilisateur
  ipAddress       String?      // IP requete
  userAgent       String?      // User agent
  details         Json?        // Details supplementaires
  previousValue   Json?        // Valeur avant
  newValue        Json?        // Valeur apres

  device          AttendanceDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  tenant          Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([deviceId])
  @@index([createdAt])
  @@index([action])
}

enum DeviceAction {
  CREATED
  UPDATED
  DELETED
  ACTIVATED
  DEACTIVATED
  SYNCED
  HEARTBEAT
  API_KEY_GENERATED
  API_KEY_ROTATED
  API_KEY_REVOKED
  IP_WHITELIST_UPDATED
  CONNECTION_FAILED
  CONNECTION_RESTORED
}

model Attendance {
  id                   String                 @id @default(uuid())
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  tenantId             String
  employeeId           String
  siteId               String?
  deviceId             String?
  timestamp            DateTime
  type                 AttendanceType
  method               DeviceType
  latitude             Decimal?
  longitude            Decimal?
  hasAnomaly           Boolean                @default(false)
  anomalyType          String?
  anomalyNote          String?
  isCorrected          Boolean                @default(false)
  correctedBy          String?
  correctedAt          DateTime?
  correctionNote       String?
  hoursWorked          Decimal?
  lateMinutes          Int?
  earlyLeaveMinutes    Int?
  overtimeMinutes      Int?
  needsApproval        Boolean                @default(false)
  approvalStatus       String?
  approvedBy           String?
  approvedAt           DateTime?
  rawData              Json?
  generatedBy          String?
  isGenerated          Boolean                @default(false)
  // Champs pour validation des pointages ambigus (shifts de nuit)
  isAmbiguous          Boolean                @default(false)
  ambiguityReason      String?
  validationStatus     ValidationStatus       @default(NONE)
  validatedBy          String?
  validatedAt          DateTime?
  escalationLevel      Int                    @default(0)  // 0=none, 1=manager notified, 2=RH escalated

  // ═══════════════════════════════════════════════════════════════════════════════
  // NOUVEAUX CHAMPS - STATE TERMINAL (19/01/2026)
  // ═══════════════════════════════════════════════════════════════════════════════
  terminalState        Int?                   // State brut du terminal (0=IN, 1=OUT, 2-5=autres)
  source               String                 @default("TERMINAL") // TERMINAL, MANUAL, IMPORT, LEGACY
  detectionMethod      String?                // TERMINAL_STATE, LEGACY_DEDUCTION, MANUAL

  device               AttendanceDevice?      @relation(fields: [deviceId], references: [id])
  employee             Employee               @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  site                 Site?                  @relation(fields: [siteId], references: [id])
  tenant               Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  attendanceAnomalies  AttendanceAnomaly[]
  supplementaryDays    SupplementaryDay[]

  @@index([tenantId])
  @@index([employeeId])
  @@index([timestamp])
  @@index([hasAnomaly])
  @@index([needsApproval])
  @@index([validationStatus])
  @@index([isAmbiguous])
  @@index([tenantId, employeeId, timestamp])
  @@index([source])
}

model AttendanceAttempt {
  id           String            @id @default(uuid())
  createdAt    DateTime          @default(now())
  tenantId     String
  employeeId   String
  deviceId     String?
  timestamp    DateTime
  type         AttendanceType
  method       DeviceType
  status       String
  errorCode    String?
  errorMessage String?
  rawData      Json?
  device       AttendanceDevice? @relation(fields: [deviceId], references: [id])
  employee     Employee          @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, employeeId, timestamp])
  @@index([status])
  @@index([tenantId])
}

model LeaveType {
  id               String   @id @default(uuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  tenantId         String
  name             String
  code             String
  isPaid           Boolean  @default(true)
  requiresDocument Boolean  @default(false)
  maxDaysPerYear   Int?
  leaves           Leave[]
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model Leave {
  id                 String      @id @default(uuid())
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  tenantId           String
  employeeId         String
  leaveTypeId        String
  startDate          DateTime    @db.Date
  endDate            DateTime    @db.Date
  days               Decimal
  reason             String?
  document           String?
  documentName       String?
  documentSize       Int?
  documentMimeType   String?
  documentUploadedBy String?
  documentUploadedAt DateTime?
  documentUpdatedBy  String?
  documentUpdatedAt  DateTime?
  status             LeaveStatus @default(PENDING)
  managerApprovedBy  String?
  managerApprovedAt  DateTime?
  managerComment     String?
  hrApprovedBy       String?
  hrApprovedAt       DateTime?
  hrComment          String?
  employee           Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType          LeaveType   @relation(fields: [leaveTypeId], references: [id])
  tenant             Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  suspendedSchedules Schedule[]  @relation("ScheduleSuspendedByLeave")

  @@index([tenantId])
  @@index([employeeId])
  @@index([startDate])
  @@index([tenantId, employeeId, startDate, endDate])
}

model Overtime {
  id                           String                @id @default(uuid())
  createdAt                    DateTime              @default(now())
  updatedAt                    DateTime              @updatedAt
  tenantId                     String
  employeeId                   String
  date                         DateTime              @db.Date
  hours                        Decimal
  approvedHours                Decimal?
  type                         OvertimeType          @default(STANDARD)
  isNightShift                 Boolean               @default(false)
  rate                         Decimal               @default(1.25)
  convertedToRecovery          Boolean               @default(false)
  recoveryId                   String?
  convertedHoursToRecovery     Decimal               @default(0)
  convertedToRecoveryDays      Boolean               @default(false)
  convertedHoursToRecoveryDays Decimal               @default(0)
  status                       OvertimeStatus        @default(PENDING)
  approvedBy                   String?
  approvedAt                   DateTime?
  rejectionReason              String?
  notes                        String?
  employee                     Employee              @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  tenant                       Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  recoveryDays                 OvertimeRecoveryDay[]

  @@index([tenantId])
  @@index([employeeId])
  @@index([status])
  @@index([type])
  @@index([tenantId, employeeId, date, status])
}

model Recovery {
  id             String    @id @default(uuid())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  tenantId       String
  employeeId     String
  hours          Decimal
  source         String?
  usedHours      Decimal   @default(0)
  remainingHours Decimal
  expiryDate     DateTime?
  employee       Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([employeeId])
}

model RecoveryDay {
  id              String                @id @default(uuid())
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  tenantId        String
  employeeId      String
  startDate       DateTime              @db.Date
  endDate         DateTime              @db.Date
  days            Decimal
  sourceHours     Decimal
  conversionRate  Decimal?
  status          RecoveryDayStatus     @default(PENDING)
  approvedBy      String?
  approvedAt      DateTime?
  notes           String?
  overtimeSources         OvertimeRecoveryDay[]
  supplementaryDaySources SupplementaryDayRecoveryDay[]
  employee        Employee              @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  tenant          Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([employeeId])
  @@index([startDate])
  @@index([status])
}

model OvertimeRecoveryDay {
  id            String      @id @default(uuid())
  overtimeId    String
  recoveryDayId String
  hoursUsed     Decimal
  overtime      Overtime    @relation(fields: [overtimeId], references: [id], onDelete: Cascade)
  recoveryDay   RecoveryDay @relation(fields: [recoveryDayId], references: [id], onDelete: Cascade)

  @@unique([overtimeId, recoveryDayId])
  @@index([overtimeId])
  @@index([recoveryDayId])
}

model SupplementaryDayRecoveryDay {
  id                  String          @id @default(uuid())
  supplementaryDayId  String
  recoveryDayId       String
  hoursUsed           Decimal
  supplementaryDay    SupplementaryDay @relation(fields: [supplementaryDayId], references: [id], onDelete: Cascade)
  recoveryDay         RecoveryDay      @relation(fields: [recoveryDayId], references: [id], onDelete: Cascade)

  @@unique([supplementaryDayId, recoveryDayId])
  @@index([supplementaryDayId])
  @@index([recoveryDayId])
}

// Jours Supplémentaires - Travail en dehors du planning (weekend, férié)
model SupplementaryDay {
  id              String                 @id @default(uuid())
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  tenantId        String
  employeeId      String

  date            DateTime               @db.Date
  hours           Decimal                // Heures travaillées ce jour
  approvedHours   Decimal?               // Heures approuvées par le manager

  type            SupplementaryDayType   @default(WEEKEND_SATURDAY)
  source          String                 @default("AUTO_DETECTED") // AUTO_DETECTED, MANUAL

  // Informations de pointage
  checkIn         DateTime?
  checkOut        DateTime?
  attendanceId    String?                // Lien vers le pointage OUT source

  // Workflow d'approbation (même que Overtime)
  status          OvertimeStatus         @default(PENDING)
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?

  // Conversion en récupération (même logique que Overtime)
  convertedToRecovery          Boolean   @default(false)
  convertedToRecoveryDays      Boolean   @default(false)
  convertedHoursToRecoveryDays Decimal   @default(0)

  notes           String?

  // Relations
  employee         Employee                      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  tenant           Tenant                        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  attendance       Attendance?                   @relation(fields: [attendanceId], references: [id], onDelete: SetNull)
  recoveryDayLinks SupplementaryDayRecoveryDay[]

  @@index([tenantId])
  @@index([employeeId])
  @@index([status])
  @@index([type])
  @@index([date])
  @@index([tenantId, employeeId, date])
  @@index([attendanceId])
}

model Holiday {
  id          String      @id @default(uuid())
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  tenantId    String
  name        String
  date        DateTime    @db.Date
  isRecurring Boolean     @default(false)
  type        HolidayType @default(NATIONAL)
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([date])
}

model AuditLog {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  tenantId  String
  userId    String?
  action    String
  entity    String
  entityId  String?
  oldValues Json?
  newValues Json?
  ipAddress String?
  userAgent String?
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([createdAt])
  @@index([entity])
}

model Notification {
  id         String           @id @default(uuid())
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  tenantId   String
  employeeId String
  type       NotificationType
  title      String
  message    String
  isRead     Boolean          @default(false)
  readAt     DateTime?
  metadata   Json?
  employee   Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  tenant     Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([employeeId])
  @@index([isRead])
}

model Role {
  id          String           @id @default(uuid())
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  tenantId    String?
  name        String
  code        String
  description String?
  isSystem    Boolean          @default(false)
  isActive    Boolean          @default(true)
  tenant      Tenant?          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  permissions RolePermission[]
  userRoles   UserTenantRole[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([code])
}

model Permission {
  id              String           @id @default(uuid())
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  code            String           @unique
  name            String
  description     String?
  category        String
  isActive        Boolean          @default(true)
  rolePermissions RolePermission[]

  @@index([category])
  @@index([code])
}

model RolePermission {
  id           String     @id @default(uuid())
  createdAt    DateTime   @default(now())
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model UserPreferences {
  id            String   @id @default(uuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  userId        String   @unique
  language      String   @default("fr")
  timezone      String   @default("Africa/Casablanca")
  dateFormat    String   @default("DD/MM/YYYY")
  timeFormat    String   @default("24h")
  notifications Json?
  theme         String   @default("light")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserSession {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  userId     String
  tokenId    String   @unique
  device     String?
  browser    String?
  os         String?
  location   String?
  ipAddress  String?
  userAgent  String?
  lastActive DateTime @default(now())
  expiresAt  DateTime
  isActive   Boolean  @default(true)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenId])
  @@index([isActive])
}

model UserCredentials {
  id         String    @id @default(uuid())
  createdAt  DateTime  @default(now())
  userId     String    @unique
  employeeId String?   @unique
  email      String
  password   String
  expiresAt  DateTime
  viewedAt   DateTime?
  viewCount  Int       @default(0)
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([employeeId])
  @@index([expiresAt])
}

model UserTenantRole {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  userId     String
  tenantId   String
  roleId     String
  assignedBy String?
  assignedAt DateTime @default(now())
  isActive   Boolean  @default(true)
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId, roleId])
  @@index([userId])
  @@index([tenantId])
  @@index([roleId])
}

model ReportHistory {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  tenantId   String
  userId     String
  reportType String
  format     String
  fileName   String
  filePath   String?
  fileSize   Int?
  filters    Json?
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([reportType])
  @@index([createdAt])
}

model MissingOutNotificationLog {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  tenantId    String
  employeeId  String
  managerId   String
  sessionDate DateTime @db.Date
  sentAt      DateTime @default(now())
  inTimestamp DateTime
  shiftEnd    String
  employee    User     @relation("EmployeeMissingOutNotifications", fields: [employeeId], references: [id], onDelete: Cascade)
  manager     User     @relation("ManagerMissingOutNotifications", fields: [managerId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, employeeId, sessionDate, shiftEnd])
  @@index([tenantId, sentAt])
  @@index([employeeId])
  @@index([managerId])
  @@map("missing_out_notification_logs")
}

model MissingInNotificationLog {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  tenantId    String
  employeeId  String
  managerId   String
  sessionDate DateTime @db.Date
  sentAt      DateTime @default(now())
  shiftStart  String
  employee    User     @relation("EmployeeMissingInNotifications", fields: [employeeId], references: [id], onDelete: Cascade)
  manager     User     @relation("ManagerMissingInNotifications", fields: [managerId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, employeeId, sessionDate, shiftStart])
  @@index([tenantId, sentAt])
  @@index([employeeId])
  @@index([managerId])
  @@map("missing_in_notification_logs")
}

model LateNotificationLog {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  tenantId    String
  employeeId  String
  managerId   String
  sessionDate DateTime @db.Date
  sentAt      DateTime @default(now())
  shiftStart  String
  actualIn    DateTime
  lateMinutes Int
  employee    User     @relation("EmployeeLateNotifications", fields: [employeeId], references: [id], onDelete: Cascade)
  manager     User     @relation("ManagerLateNotifications", fields: [managerId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, employeeId, sessionDate, shiftStart])
  @@index([tenantId, sentAt])
  @@index([employeeId])
  @@index([managerId])
  @@map("late_notification_logs")
}

model AbsenceNotificationLog {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  tenantId    String
  employeeId  String
  managerId   String
  sessionDate DateTime @db.Date
  sentAt      DateTime @default(now())
  shiftStart  String
  employee    User     @relation("EmployeeAbsenceNotifications", fields: [employeeId], references: [id], onDelete: Cascade)
  manager     User     @relation("ManagerAbsenceNotifications", fields: [managerId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, employeeId, sessionDate, shiftStart])
  @@index([tenantId, sentAt])
  @@index([employeeId])
  @@index([managerId])
  @@map("absence_notification_logs")
}

model AbsencePartialNotificationLog {
  id           String    @id @default(uuid())
  createdAt    DateTime  @default(now())
  tenantId     String
  employeeId   String
  managerId    String
  sessionDate  DateTime  @db.Date
  sentAt       DateTime  @default(now())
  missingType  String
  outTimestamp DateTime?
  employee     User      @relation("EmployeeAbsencePartialNotifications", fields: [employeeId], references: [id], onDelete: Cascade)
  manager      User      @relation("ManagerAbsencePartialNotifications", fields: [managerId], references: [id], onDelete: Cascade)
  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, employeeId, sessionDate, missingType])
  @@index([tenantId, sentAt])
  @@index([employeeId])
  @@index([managerId])
  @@map("absence_partial_notification_logs")
}

model AbsenceTechnicalNotificationLog {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  tenantId    String
  employeeId  String
  managerId   String
  anomalyId   String
  sessionDate DateTime @db.Date
  sentAt      DateTime @default(now())
  reason      String
  employee    User     @relation("EmployeeAbsenceTechnicalNotifications", fields: [employeeId], references: [id], onDelete: Cascade)
  manager     User     @relation("ManagerAbsenceTechnicalNotifications", fields: [managerId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, anomalyId])
  @@index([tenantId, sentAt])
  @@index([employeeId])
  @@index([managerId])
  @@map("absence_technical_notification_logs")
}

model EmailConfig {
  id                     String   @id @default(uuid())
  tenantId               String   @unique
  enabled                Boolean  @default(false)
  provider               String   @default("gmail")
  host                   String   @default("smtp.gmail.com")
  port                   Int      @default(587)
  secure                 Boolean  @default(false)
  username               String?
  password               String?
  fromName               String   @default("PointaFlex")
  fromEmail              String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  notifyAbsence          Boolean  @default(true)
  notifyAbsencePartial   Boolean  @default(true)
  notifyAbsenceTechnical Boolean  @default(true)
  notifyLate             Boolean  @default(true)
  notifyMissingIn        Boolean  @default(true)
  notifyMissingOut       Boolean  @default(true)
  notifyOvertimePending  Boolean  @default(true)
  tenant                 Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("email_configs")
}

model OvertimePendingNotificationLog {
  id           String   @id @default(uuid())
  createdAt    DateTime @default(now())
  tenantId     String
  managerId    String
  sentAt       DateTime @default(now())
  pendingCount Int
  totalHours   Decimal
  manager      User     @relation("ManagerOvertimePendingNotifications", fields: [managerId], references: [id], onDelete: Cascade)
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, sentAt])
  @@index([managerId])
  @@map("overtime_pending_notification_logs")
}

model EmailTemplate {
  id          String     @id @default(uuid())
  tenantId    String
  code        String
  name        String
  description String?
  subject     String
  htmlContent String
  variables   Json
  category    String     @default("notification")
  active      Boolean    @default(true)
  isDefault   Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  emailLogs   EmailLog[]
  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@map("email_templates")
}

model EmailLog {
  id         String         @id @default(uuid())
  tenantId   String
  to         String
  cc         String?
  bcc        String?
  subject    String
  type       String
  templateId String?
  sentAt     DateTime       @default(now())
  status     String         @default("sent")
  error      String?
  employeeId String?
  managerId  String?
  employee   User?          @relation("EmployeeEmailLogs", fields: [employeeId], references: [id])
  manager    User?          @relation("ManagerEmailLogs", fields: [managerId], references: [id])
  template   EmailTemplate? @relation(fields: [templateId], references: [id])
  tenant     Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, sentAt])
  @@index([tenantId, type])
  @@map("email_logs")
}

model AttendanceAnomaly {
  id               String            @id @default(uuid())
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  tenantId         String
  attendanceId     String?
  employeeId       String
  scheduleId       String?
  deviceId         String?
  type             String
  subType          String?
  severity         String            @default("MEDIUM")
  description      String
  detectedAt       DateTime          @default(now())
  occurredAt       DateTime
  metadata         Json?
  status           String            @default("OPEN")
  resolvedAt       DateTime?
  resolvedBy       String?
  resolution       String?
  notifiedAt       DateTime?
  attendance       Attendance?       @relation(fields: [attendanceId], references: [id])
  device           AttendanceDevice? @relation(fields: [deviceId], references: [id])
  employee         Employee          @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  resolvedByUser   User?             @relation(fields: [resolvedBy], references: [id])
  schedule         Schedule?         @relation(fields: [scheduleId], references: [id])
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([detectedAt])
  @@index([employeeId])
  @@index([severity])
  @@index([status])
  @@index([tenantId, employeeId, detectedAt])
  @@index([tenantId])
  @@index([tenantId, status, severity])
  @@index([type])
  @@map("attendance_anomalies")
}

enum RecoveryDayStatus {
  PENDING
  APPROVED
  USED
  CANCELLED
}

enum LegacyRole {
  SUPER_ADMIN
  ADMIN_RH
  MANAGER
  EMPLOYEE
}

enum ScheduleStatus {
  PUBLISHED
  DRAFT
  CANCELLED
  SUSPENDED_BY_LEAVE
}

enum ReplacementStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DeviceType {
  FINGERPRINT
  FACE_RECOGNITION
  RFID_BADGE
  QR_CODE
  PIN_CODE
  MOBILE_GPS
  MANUAL
}

enum AttendanceType {
  IN
  OUT
  BREAK_START
  BREAK_END
  MISSION_START
  MISSION_END
}

enum ValidationStatus {
  NONE               // Pas de validation requise
  PENDING_VALIDATION // En attente de validation
  VALIDATED          // Validé par manager/RH
  REJECTED           // Rejeté (pointage erroné)
}

enum LeaveStatus {
  PENDING
  MANAGER_APPROVED
  HR_APPROVED
  APPROVED
  REJECTED
  CANCELLED
}

enum OvertimeStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
  RECOVERED
}

enum OvertimeType {
  STANDARD
  NIGHT
  HOLIDAY
  EMERGENCY
}

enum SupplementaryDayType {
  WEEKEND_SATURDAY  // Samedi
  WEEKEND_SUNDAY    // Dimanche
  HOLIDAY           // Jour férié (semaine ou weekend)
}

enum HolidayType {
  NATIONAL
  COMPANY
  RELIGIOUS
}

enum NotificationType {
  SHIFT_CHANGE
  LEAVE_APPROVED
  LEAVE_REJECTED
  OVERTIME_APPROVED
  SCHEDULE_UPDATED
  REPLACEMENT_REQUEST
  ALERT_LEGAL
  SYSTEM
  ATTENDANCE_ANOMALY
  ATTENDANCE_CORRECTED
  ATTENDANCE_APPROVAL_REQUIRED
  TEMPORARY_MATRICULE_EXPIRING
  TEMPORARY_MATRICULE_EXPIRED
}
